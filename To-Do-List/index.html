<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do-List</title>
    <link rel="stylesheet" href="style.css" type="text/css">
</head>
<body>
    <div class="container">
        <div class="todo-app">
            <h2>To-Do List <img src="images/icon.png" alt="icon"></h2>
            <div class="row">
                <input type="text" id="input-box" placeholder="Add your text">
                <button onclick="addTask()">Add</button>
            </div>
            <ul id="list-container">
                <!--<li class="checked">Task 1</li>
                <li>Task 2</li>
                <li>Task 3</li>-->
            </ul>
        </div>
    </div>
    <script src="script.js"></script>
</body>

    
</html>



import React, { useEffect, useRef, useState, useMemo } from "react";
import axios from "axios";
import { Modal } from "bootstrap";
import { FileText, CheckCircle, XCircle, Filter, X, Search, ChevronLeft, ChevronRight } from 'lucide-react';
import "./OfferConfirmation.css";

const API_BASE = "http://localhost:8080";

export default function OfferConfirmation() {
  const [data, setData] = useState([]);
  const [who, setWho] = useState(null);
  const [disabledIds, setDisabledIds] = useState(new Set());
  const [showFilters, setShowFilters] = useState(false);
  const [loading, setLoading] = useState(true);
  const [rejectReason, setRejectReason] = useState("");
  const [actionWho, setActionWho] = useState(null);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage] = useState(10);
  const [expandedRow, setExpandedRow] = useState(null);
  const [dropdownPosition, setDropdownPosition] = useState({ top: 0, left: 0 });
  const [filters, setFilters] = useState({
    query: '',
    status: 'All',
    sortDir: 'oldest'
  });

  const modalRef = useRef(null);
  const bsModal = useRef(null);
  const token = localStorage.getItem("token");

  useEffect(() => {
    if (modalRef.current && !bsModal.current) {
      bsModal.current = new Modal(modalRef.current, {
        backdrop: "static",
        keyboard: true,
      });
    }
  }, []);

  const fetchApprovedData = async () => {
    try {
      setLoading(true);
      const res = await axios.get(`${API_BASE}/api/offer/approved`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      setData(res.data || []);
    } catch (err) {
      console.error("Fetch Error:", err);
      setData([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchApprovedData();
  }, []);

  const toTime = (d) => new Date(d).getTime();

  const filteredAndSorted = useMemo(() => {
    const q = filters.query.trim().toLowerCase();
    let rows = data.filter((r) => {
      const s = r.fullName?.toLowerCase() || "";
      const searchMatch = q === "" || s.includes(q);
      
      // Filter by offerStatus (APPROVED, REJECTED, or pending/null)
      let statusMatch = true;
      if (filters.status === "APPROVED") {
        statusMatch = r.offerStatus === "APPROVED";
      } else if (filters.status === "REJECTED") {
        statusMatch = r.offerStatus === "REJECTED";
      }
      // "All" shows everything
      
      return searchMatch && statusMatch;
    });

    return rows.sort((a, b) =>
      filters.sortDir === "oldest"
        ? toTime(a.submittedAt) - toTime(b.submittedAt)
        : toTime(b.submittedAt) - toTime(a.submittedAt)
    );
  }, [data, filters]);

  // Pagination
  const indexOfLastItem = currentPage * itemsPerPage;
  const indexOfFirstItem = indexOfLastItem - itemsPerPage;
  const currentItems = filteredAndSorted.slice(indexOfFirstItem, indexOfLastItem);
  const totalPages = Math.ceil(filteredAndSorted.length / itemsPerPage);

  const paginate = (pageNumber) => setCurrentPage(pageNumber);

  const stats = {
    total: data.length,
    approved: data.filter(a => a.offerStatus === 'APPROVED').length,
    pending: data.filter(a => !a.offerStatus || a.offerStatus === 'PENDING').length,
    rejected: data.filter(a => a.offerStatus === 'REJECTED').length
  };

  const activeFiltersCount = Object.values(filters).filter(v => v !== '' && v !== 'All' && v !== 'oldest').length;

  const resetFilters = () => {
    setFilters({ query: '', status: 'All', sortDir: 'oldest' });
    setCurrentPage(1);
  };

  const handleVerifyClick = (e, appId) => {
    const rect = e.currentTarget.getBoundingClientRect();
    setDropdownPosition({
      top: rect.bottom + window.scrollY + 5,
      left: rect.left + window.scrollX
    });
    setExpandedRow(expandedRow === appId ? null : appId);
  };

  const handleActionClick = async (row) => {
    if (disabledIds.has(row.appId)) return;
    setDisabledIds((prev) => new Set(prev).add(row.appId));

    try {
      const res = await axios.get(`${API_BASE}/api/offer/credit-score/${row.appId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const updatedRow = { ...row, ...res.data };
      setWho(updatedRow);
      bsModal.current?.show();
    } catch (err) {
      console.error("Credit Score Error:", err);
      alert("Unable to generate credit score!");
      setDisabledIds((prev) => {
        const newSet = new Set(prev);
        newSet.delete(row.appId);
        return newSet;
      });
    }
  };

  const handleModalClose = () => {
    // Re-enable buttons when modal is closed without confirming
    if (who?.appId) {
      setDisabledIds((prev) => {
        const newSet = new Set(prev);
        newSet.delete(who.appId);
        return newSet;
      });
    }
    setWho(null);
    bsModal.current?.hide();
  };

  const processOffer = async (row, action) => {
    try {
      const payload = {
        appId: row.appId,
        action,
        creditScore: row.creditScore,
      };

      if (action === "REJECTED") {
        payload.rejectReason = rejectReason;
      }

      await axios.post(`${API_BASE}/api/offer/process`, payload, {
        headers: { Authorization: `Bearer ${token}` },
      });

      alert(`✅ Application ${action}`);
      fetchApprovedData();
      setRejectReason("");
      setExpandedRow(null);
      bsModal.current?.hide();
    } catch (err) {
      console.error("Offer Process Error:", err);
      alert("❌ Failed to update status");
    }
  };

  const openRejectPopup = (row) => {
    setActionWho(row);
    const mdl = new Modal(document.getElementById("rejectModal"));
    mdl.show();
  };

  const confirmReject = () => {
    const mdl = Modal.getInstance(document.getElementById("rejectModal"));
    mdl.hide();
    processOffer(actionWho, "REJECTED");
  };

  const getStatusBadge = (status) => {
    const badges = {
      APPROVED: { class: 'offer-status-approved', text: 'Approved' },
      REJECTED: { class: 'offer-status-rejected', text: 'Rejected' }
    };
    const badge = badges[status] || { class: 'offer-status-pending', text: status };
    return <span className={`offer-status-badge ${badge.class}`}>{badge.text}</span>;
  };

  return (
    <div className="offer-page-container">
      <header className="offer-header-section">
        <div className="offer-header-content">
          <div className="offer-header-left">
            <h1 className="offer-page-title">Offer Confirmation</h1>
            <p className="offer-page-subtitle">Review and process credit offers</p>
          </div>
          <div className="offer-stats-container">
            <div className="offer-stat-card">
              <div className="offer-stat-icon offer-stat-icon-total">
                <FileText size={24} />
              </div>
              <div className="offer-stat-info">
                <p className="offer-stat-label">Total Applications</p>
                <p className="offer-stat-value">{stats.total}</p>
              </div>
            </div>
            <div className="offer-stat-card">
              <div className="offer-stat-icon offer-stat-icon-pending">
                <CheckCircle size={24} />
              </div>
              <div className="offer-stat-info">
                <p className="offer-stat-label">Pending Offers</p>
                <p className="offer-stat-value">{stats.pending}</p>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div className="offer-content-section">
        <div className="offer-filters-section">
          <div className="offer-filters-header">
            <button
              className={`offer-filter-toggle-btn ${showFilters ? 'active' : ''}`}
              onClick={() => setShowFilters(!showFilters)}
            >
              <Filter size={20} />
              Filters
              {activeFiltersCount > 0 && (
                <span className="offer-filter-count">{activeFiltersCount}</span>
              )}
            </button>
            {activeFiltersCount > 0 && (
              <button className="offer-reset-filters-btn" onClick={resetFilters}>
                <X size={16} />
                Reset Filters
              </button>
            )}
          </div>
          <div className={`offer-filters-content ${showFilters ? 'show' : ''}`}>
            <div className="offer-filter-grid">
              <div className="offer-filter-group">
                <label className="offer-filter-label">Search</label>
                <div className="offer-search-input-wrapper">
                  <Search size={18} />
                  <input
                    type="text"
                    className="offer-filter-input"
                    placeholder="Search by name..."
                    value={filters.query}
                    onChange={(e) => {
                      setFilters({...filters, query: e.target.value});
                      setCurrentPage(1);
                    }}
                  />
                </div>
              </div>
              <div className="offer-filter-group">
                <label className="offer-filter-label">Status</label>
                <select
                  className="offer-filter-select"
                  value={filters.status}
                  onChange={(e) => {
                    setFilters({...filters, status: e.target.value});
                    setCurrentPage(1);
                  }}
                >
                  <option value="All">All</option>
                  <option value="APPROVED">Approved</option>
                  <option value="REJECTED">Rejected</option>
                </select>
              </div>
              <div className="offer-filter-group">
                <label className="offer-filter-label">Sort By Date</label>
                <select
                  className="offer-filter-select"
                  value={filters.sortDir}
                  onChange={(e) => setFilters({...filters, sortDir: e.target.value})}
                >
                  <option value="oldest">Date (Oldest First)</option>
                  <option value="newest">Date (Newest First)</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        {loading ? (
          <div className="offer-table-container">
            <p className="text-center py-4">Loading...</p>
          </div>
        ) : (
          <div className="offer-table-container">
            <div className="offer-table-wrapper">
              <table className="offer-applications-table">
                <thead>
                  <tr>
                    <th>APPLICANT NO</th>
                    <th>APPLICANT NAME</th>
                    <th>APPLICATION DATE</th>
                    <th>DOCUMENT STATUS</th>
                    <th>Card Type</th>
                    <th>ACTION</th>
                  </tr>
                </thead>
                <tbody>
                  {currentItems.map((r) => {
                    const isDisabled = disabledIds.has(r.appId);
                    return (
                      <tr key={r.appId}>
                        <td><span className="offer-app-id">{r.appId.substring(0, 8)}</span></td>
                        <td><div className="offer-user-name">{r.fullName}</div></td>
                        <td><span className="offer-date-text">{r.submittedAt?.split("T")[0]}</span></td>
                        <td>{getStatusBadge(r.documentVerificationStatus)}</td>
                        <td>{r.cardType || "-"}</td>
                        <td>
                          {r.offerStatus === "APPROVED" ? (
                            <span className="offer-status-badge offer-status-approved" style={{ display: 'inline-flex', minWidth: '120px', justifyContent: 'center' }}>
                              <CheckCircle size={16} />
                              Approved
                            </span>
                          ) : r.offerStatus === "REJECTED" ? (
                            <span className="offer-status-badge offer-status-rejected" style={{ display: 'inline-flex', minWidth: '120px', justifyContent: 'center' }}>
                              <XCircle size={16} />
                              Rejected
                            </span>
                          ) : (
                            <button
                              className="offer-verify-btn"
                              onClick={(e) => handleVerifyClick(e, r.appId)}
                              disabled={isDisabled}
                            >
                              <FileText size={16} />
                              Verify
                            </button>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                  {currentItems.length === 0 && (
                    <tr>
                      <td colSpan="6" className="text-center text-muted py-3">
                        No results found.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>

            {/* Pagination */}
            {totalPages > 1 && (
              <div className="offer-pagination-container">
                <button 
                  className="offer-pagination-btn"
                  onClick={() => paginate(currentPage - 1)}
                  disabled={currentPage === 1}
                >
                  <ChevronLeft size={18} />
                  Previous
                </button>
                <div className="offer-pagination-info">
                  Page {currentPage} of {totalPages}
                </div>
                <button 
                  className="offer-pagination-btn"
                  onClick={() => paginate(currentPage + 1)}
                  disabled={currentPage === totalPages}
                >
                  Next
                  <ChevronRight size={18} />
                </button>
              </div>
            )}
          </div>
        )}

        <p className="mt-3 small text-muted text-center">
          When credit score is generated, notification is sent automatically.
        </p>
      </div>

      {/* Floating Action Menu */}
      {expandedRow && (
        <>
          <div className="offer-dropdown-overlay" onClick={() => setExpandedRow(null)}></div>
          <div 
            className="offer-floating-menu"
            style={{
              top: `${dropdownPosition.top}px`,
              left: `${dropdownPosition.left}px`
            }}
          >
            <button
              className="offer-dropdown-item offer-approve-item"
              onClick={() => {
                const row = currentItems.find(r => r.appId === expandedRow);
                setExpandedRow(null);
                handleActionClick(row);
              }}
            >
              <CheckCircle size={16} />
              Approve
            </button>
            <button
              className="offer-dropdown-item offer-reject-item"
              onClick={() => {
                const row = currentItems.find(r => r.appId === expandedRow);
                setExpandedRow(null);
                openRejectPopup(row);
              }}
            >
              <XCircle size={16} />
              Reject
            </button>
          </div>
        </>
      )}

      {/* Credit Score Modal */}
      <div className="modal fade" ref={modalRef}>
        <div className="modal-dialog modal-dialog-centered">
          <div className="modal-content text-center">
            <div className="modal-header">
              <h5 className="modal-title">Credit Score Generated ✅</h5>
              <button className="btn-close" onClick={handleModalClose}></button>
            </div>
            <div className="modal-body">
              <h5>{who?.fullName}</h5>
              <p className="fw-bold fs-4">{who?.creditScore}</p>
              <p className="text-muted">{who?.creditRating}</p>
            </div>
            <div className="modal-footer">
              <button className="btn btn-secondary" onClick={handleModalClose}>
                Cancel
              </button>
              <button className="btn btn-primary" onClick={() => processOffer(who, "APPROVED")}>
                Confirm Approve ✅
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Reject Modal */}
      <div className="modal fade" id="rejectModal" tabIndex="-1">
        <div className="modal-dialog modal-dialog-centered">
          <div className="modal-content">
            <div className="modal-header">
              <h5 className="modal-title">Reject Offer</h5>
              <button className="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div className="modal-body">
              <label className="form-label">Reason for Rejection</label>
              <textarea
                className="form-control"
                rows="3"
                value={rejectReason}
                onChange={(e) => setRejectReason(e.target.value)}
              />
            </div>
            <div className="modal-footer">
              <button className="btn btn-secondary" data-bs-dismiss="modal">
                Cancel
              </button>
              <button className="btn btn-danger" onClick={confirmReject}>
                Reject
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}




